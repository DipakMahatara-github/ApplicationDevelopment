@page "/dashboard"
@using ApplicationDevelopment.Model
@using ApplicationDevelopment.Service
@inject NavigationManager NavManager
@inject IJSRuntime JS

<h2>üìä Journal Dashboard</h2>

<div class="dashboard-container">

    <!-- FILTERS -->
    <div class="filter-row">
        <div>
            <label>From:</label>
            <input type="date" @bind="fromDate" />
        </div>
        <div>
            <label>To:</label>
            <input type="date" @bind="toDate" />
        </div>
        <div>
            <label>Mood:</label>
            <select @bind="selectedMood">
                <option value="">All</option>
                @foreach (var mood in moodList)
                {
                    <option value="@mood">@mood</option>
                }
            </select>
        </div>
        <button class="btn-filter" @onclick="ApplyFilters">Apply</button>
    </div>

    <!-- TOP STATS -->
    <div class="stats-grid">
        <div class="stat-card">
            <h4>Total Entries</h4>
            <p>@totalEntries</p>
        </div>

        <div class="stat-card">
            <h4>Most Common Mood</h4>
            <p>@mostCommonMood</p>
        </div>

        <div class="stat-card">
            <h4>üî• Current Streak</h4>
            <p>@currentStreak days</p>
        </div>

        <div class="stat-card">
            <h4>üèÜ Longest Streak</h4>
            <p>@longestStreak days</p>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
        <div class="chart-card big-chart">
            <h4>Mood Distribution</h4>
            <canvas id="moodChart"></canvas>
        </div>

        <div class="chart-card big-chart">
            <h4>Entries Over Time</h4>
            <canvas id="entryChart"></canvas>
        </div>
    </div>

    <!-- EXTRA INSIGHTS -->
    <div class="insight-card">
        <h4>üìÖ Most Active Day</h4>
        <p>@mostActiveDay</p>
    </div>

</div>

<style>
.dashboard-container {
    max-width: 1100px;
    margin: 1rem auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* FILTERS */
.filter-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.filter-row label {
    font-weight: 600;
    margin-right: 0.3rem;
}

.btn-filter {
    background: #00B4D8;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
}

/* STATS GRID */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.stat-card {
    background: white;
    padding: 1.3rem;
    border-radius: 14px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    text-align: center;
}

.stat-card h4 {
    color: #0077B6;
    font-size: 1rem;
}

.stat-card p {
    font-size: 2rem;
    font-weight: bold;
}

/* CHARTS */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.chart-card {
    background: white;
    padding: 1.2rem;
    border-radius: 14px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
}

.big-chart {
    height: 360px;
}

.chart-card canvas {
    width: 100% !important;
    height: 260px !important;
}

/* INSIGHT */
.insight-card {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    font-size: 1.1rem;
}

/* RESPONSIVE */
@@media (max-width: 900px) {
    .stats-grid,
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>

@code {
    private List<JournalEntry> entries = new();
    private List<JournalEntry> filteredEntries = new();

    private int totalEntries;
    private string mostCommonMood = "None";
    private int currentStreak;
    private int longestStreak;
    private string mostActiveDay = "None";

    private DateTime? fromDate;
    private DateTime? toDate;
    private string selectedMood = "";
    private List<string> moodList = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsLoggedIn())
        {
            NavManager.NavigateTo("/login", true);
            return;
        }

        entries = await JournalService.GetAllEntriesAsync();
        filteredEntries = entries;

        moodList = entries.Select(e => e.PrimaryMood)
                          .Where(m => !string.IsNullOrEmpty(m))
                          .Distinct()
                          .ToList();

        CalculateStats();
        await RenderCharts();
    }

    private void ApplyFilters()
    {
        filteredEntries = entries;

        if (fromDate != null)
            filteredEntries = filteredEntries.Where(e => e.CreatedAt.Date >= fromDate.Value.Date).ToList();

        if (toDate != null)
            filteredEntries = filteredEntries.Where(e => e.CreatedAt.Date <= toDate.Value.Date).ToList();

        if (!string.IsNullOrEmpty(selectedMood))
            filteredEntries = filteredEntries.Where(e => e.PrimaryMood == selectedMood).ToList();

        CalculateStats();
        RenderCharts();
    }

    private void CalculateStats()
    {
        totalEntries = filteredEntries.Count;

        if (filteredEntries.Any())
        {
            mostCommonMood = filteredEntries
                .GroupBy(e => e.PrimaryMood)
                .OrderByDescending(g => g.Count())
                .First().Key ?? "None";

            CalculateStreaks();
            CalculateMostActiveDay();
        }
        else
        {
            mostCommonMood = "None";
            currentStreak = 0;
            longestStreak = 0;
            mostActiveDay = "None";
        }
    }

    private void CalculateStreaks()
    {
        var dates = filteredEntries
            .Select(e => e.CreatedAt.Date)
            .Distinct()
            .OrderBy(d => d)
            .ToList();

        int streak = 1;
        int maxStreak = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if (dates[i] == dates[i - 1].AddDays(1))
            {
                streak++;
                maxStreak = Math.Max(maxStreak, streak);
            }
            else
            {
                streak = 1;
            }
        }

        longestStreak = maxStreak;

        currentStreak = dates.Count > 0 && dates.Last() == DateTime.Today
            ? streak
            : 0;
    }

    private void CalculateMostActiveDay()
    {
        var day = filteredEntries
            .GroupBy(e => e.CreatedAt.Date)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();

        if (day != null)
            mostActiveDay = $"{day.Key:dd MMM yyyy} ({day.Count()} entries)";
    }

    private async Task RenderCharts()
    {
        var moodGroups = filteredEntries
            .GroupBy(e => e.PrimaryMood)
            .Select(g => new { Mood = g.Key ?? "Unknown", Count = g.Count() })
            .ToList();

        var moodLabels = moodGroups.Select(m => m.Mood).ToArray();
        var moodValues = moodGroups.Select(m => m.Count).ToArray();

        var dayGroups = filteredEntries
            .GroupBy(e => e.CreatedAt.Date)
            .OrderBy(g => g.Key)
            .Select(g => new { Date = g.Key.ToString("dd MMM"), Count = g.Count() })
            .ToList();

        var dayLabels = dayGroups.Select(d => d.Date).ToArray();
        var dayValues = dayGroups.Select(d => d.Count).ToArray();

        await JS.InvokeVoidAsync("renderMoodChart", moodLabels, moodValues);
        await JS.InvokeVoidAsync("renderEntryChart", dayLabels, dayValues);
    }
}
