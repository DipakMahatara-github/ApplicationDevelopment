@page "/dashboard"
@using ApplicationDevelopment.Model
@using ApplicationDevelopment.Service
@inject NavigationManager NavManager
@inject IJSRuntime JS

<h2>üìä Journal Dashboard</h2>

<div class="dashboard-container">

    <!-- FILTERS -->
    <div class="filter-row">
        <div>
            <label>From:</label>
            <input type="date" @bind="fromDate" />
        </div>
        <div>
            <label>To:</label>
            <input type="date" @bind="toDate" />
        </div>
        <div>
            <label>Mood:</label>
            <select @bind="selectedMood">
                <option value="">All</option>
                @foreach (var mood in moodList)
                {
                    <option value="@mood">@mood</option>
                }
            </select>
        </div>

        <div>
            <label>Category:</label>
            <select @bind="selectedMoodCategory">
                <option value="">All</option>
                <option value="Positive">Positive</option>
                <option value="Neutral">Neutral</option>
                <option value="Negative">Negative</option>
            </select>
        </div>

        <button class="btn-filter" @onclick="ApplyFilters">Apply</button>
    </div>

    <!-- TOP STATS -->
    <div class="stats-grid">
        <div class="stat-card">
            <h4>Total Entries</h4>
            <p>@totalEntries</p>
        </div>

        <div class="stat-card">
            <h4>Most Common Mood</h4>
            <p>@mostCommonMood</p>
        </div>

        <div class="stat-card">
            <h4>üòä Positive</h4>
            <p>@positiveCount</p>
        </div>

        <div class="stat-card">
            <h4>üòê Neutral</h4>
            <p>@neutralCount</p>
        </div>

        <div class="stat-card">
            <h4>üòî Negative</h4>
            <p>@negativeCount</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h4>üî• Current Streak</h4>
            <p>@currentStreak days</p>
        </div>

        <div class="stat-card">
            <h4>üèÜ Longest Streak</h4>
            <p>@longestStreak days</p>
        </div>

        <div class="stat-card">
            <h4>‚ùå Missed Days</h4>
            <p>@missedDays days</p>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
        <div class="chart-card big-chart">
            <h4>Mood Distribution</h4>
            <canvas id="moodChart"></canvas>
        </div>

        <div class="chart-card big-chart">
            <h4>Mood Category Distribution</h4>
            <canvas id="moodCategoryChart"></canvas>
        </div>

        <div class="chart-card big-chart">
            <h4>Entries Over Time</h4>
            <canvas id="entryChart"></canvas>
        </div>

        <div class="chart-card big-chart">
            <h4>Most Used Tags</h4>
            <canvas id="tagChart"></canvas>
        </div>

        <!-- ‚úÖ NEW TAG BREAKDOWN CHART -->
        <div class="chart-card big-chart">
            <h4>Tag Breakdown (%)</h4>
            <canvas id="tagBreakdownChart"></canvas>
        </div>

        <div class="chart-card big-chart">
            <h4>Word Count Trend</h4>
            <canvas id="wordChart"></canvas>
        </div>
    </div>

    <div class="insight-card">
        <h4>üìÖ Most Active Day</h4>
        <p>@mostActiveDay</p>
    </div>

</div>

<style>
/* ‚úÖ YOUR CSS (UNCHANGED) */
.dashboard-container {
    max-width: 1100px;
    margin: 1rem auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
.filter-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}
.filter-row label {
    font-weight: 600;
    margin-right: 0.3rem;
}
.btn-filter {
    background: #00B4D8;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
}
.stat-card {
    background: white;
    padding: 1.3rem;
    border-radius: 14px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    text-align: center;
}
.stat-card h4 {
    color: #0077B6;
    font-size: 1rem;
}
.stat-card p {
    font-size: 2rem;
    font-weight: bold;
}
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}
.chart-card {
    background: white;
    padding: 1.2rem;
    border-radius: 14px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
}
.big-chart {
    height: 360px;
}
.chart-card canvas {
    width: 100% !important;
    height: 260px !important;
}
.insight-card {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    font-size: 1.1rem;
}
@@media (max-width: 900px) {
    .stats-grid,
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>

@code {
    private List<JournalEntry> entries = new();
    private List<JournalEntry> filteredEntries = new();

    private int totalEntries;
    private string mostCommonMood = "None";
    private int currentStreak;
    private int longestStreak;
    private int missedDays;
    private string mostActiveDay = "None";

    private int positiveCount;
    private int neutralCount;
    private int negativeCount;

    private DateTime? fromDate;
    private DateTime? toDate;
    private string selectedMood = "";
    private string selectedMoodCategory = "";
    private List<string> moodList = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsLoggedIn())
        {
            NavManager.NavigateTo("/login", true);
            return;
        }

        entries = await JournalService.GetAllEntriesAsync();

        foreach (var e in entries)
            e.LoadTags();

        filteredEntries = entries;

        moodList = entries.Select(e => e.PrimaryMood)
                          .Where(m => !string.IsNullOrEmpty(m))
                          .Distinct()
                          .ToList();

        CalculateStats();
        await RenderCharts();
    }

    private void ApplyFilters()
    {
        filteredEntries = entries;

        if (fromDate != null)
            filteredEntries = filteredEntries.Where(e => e.CreatedAt.Date >= fromDate.Value.Date).ToList();

        if (toDate != null)
            filteredEntries = filteredEntries.Where(e => e.CreatedAt.Date <= toDate.Value.Date).ToList();

        if (!string.IsNullOrEmpty(selectedMood))
            filteredEntries = filteredEntries.Where(e => e.PrimaryMood == selectedMood).ToList();

        if (!string.IsNullOrEmpty(selectedMoodCategory))
            filteredEntries = filteredEntries.Where(e => e.MoodCategory == selectedMoodCategory).ToList();

        CalculateStats();
        RenderCharts();
    }

    private void CalculateStats()
    {
        totalEntries = filteredEntries.Count;

        positiveCount = filteredEntries.Count(e => e.MoodCategory == "Positive");
        neutralCount = filteredEntries.Count(e => e.MoodCategory == "Neutral");
        negativeCount = filteredEntries.Count(e => e.MoodCategory == "Negative");

        if (filteredEntries.Any())
        {
            mostCommonMood = filteredEntries
                .GroupBy(e => e.PrimaryMood)
                .OrderByDescending(g => g.Count())
                .First().Key ?? "None";

            CalculateStreaks();
            CalculateMostActiveDay();
            CalculateMissedDays();
        }
        else
        {
            mostCommonMood = "None";
            currentStreak = 0;
            longestStreak = 0;
            mostActiveDay = "None";
            missedDays = 0;
        }
    }

    private void CalculateStreaks()
    {
        var dates = filteredEntries.Select(e => e.CreatedAt.Date).Distinct().OrderBy(d => d).ToList();

        int streak = 1;
        int maxStreak = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if (dates[i] == dates[i - 1].AddDays(1))
            {
                streak++;
                maxStreak = Math.Max(maxStreak, streak);
            }
            else streak = 1;
        }

        longestStreak = maxStreak;
        currentStreak = dates.LastOrDefault() == DateTime.Today ? streak : 0;
    }

    private void CalculateMissedDays()
    {
        var dates = filteredEntries.Select(e => e.CreatedAt.Date).Distinct().OrderBy(d => d).ToList();
        if (!dates.Any()) { missedDays = 0; return; }

        var startDate = dates.First();
        var endDate = DateTime.Today;
        missedDays = (endDate - startDate).Days + 1 - dates.Count;
        if (missedDays < 0) missedDays = 0;
    }

    private void CalculateMostActiveDay()
    {
        var day = filteredEntries.GroupBy(e => e.CreatedAt.Date)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();

        if (day != null)
            mostActiveDay = $"{day.Key:dd MMM yyyy} ({day.Count()} entries)";
    }

    private async Task RenderCharts()
    {
        var moodGroups = filteredEntries.GroupBy(e => e.PrimaryMood)
            .Select(g => new { Mood = g.Key ?? "Unknown", Count = g.Count() }).ToList();

        var moodLabels = moodGroups.Select(m => m.Mood).ToArray();
        var moodValues = moodGroups.Select(m => m.Count).ToArray();

        var categoryLabels = new[] { "Positive", "Neutral", "Negative" };
        var categoryValues = new[] { positiveCount, neutralCount, negativeCount };

        var dayGroups = filteredEntries.GroupBy(e => e.CreatedAt.Date)
            .OrderBy(g => g.Key)
            .Select(g => new { Date = g.Key.ToString("dd MMM"), Count = g.Count() }).ToList();

        var dayLabels = dayGroups.Select(d => d.Date).ToArray();
        var dayValues = dayGroups.Select(d => d.Count).ToArray();

        var tagGroups = filteredEntries.SelectMany(e => e.Tags)
            .GroupBy(t => t)
            .Select(g => new { Tag = g.Key, Count = g.Count() }).ToList();

        var tagLabels = tagGroups.Select(t => t.Tag).ToArray();
        var tagValues = tagGroups.Select(t => t.Count).ToArray();

        // ‚úÖ TAG BREAKDOWN (%)
        var totalTags = filteredEntries.SelectMany(e => e.Tags).Count();

        var tagBreakdownGroups = filteredEntries.SelectMany(e => e.Tags)
            .GroupBy(t => t)
            .Select(g => new {
                Tag = g.Key,
                Percentage = totalTags == 0 ? 0 : Math.Round((g.Count() * 100.0) / totalTags, 2)
            })
            .ToList();

        var tagBreakdownLabels = tagBreakdownGroups.Select(t => t.Tag).ToArray();
        var tagBreakdownValues = tagBreakdownGroups.Select(t => t.Percentage).ToArray();

        var wordGroups = filteredEntries.GroupBy(e => e.CreatedAt.Date)
            .Select(g => new {
                Date = g.Key.ToString("dd MMM"),
                Words = g.Sum(e => (e.Content ?? "").Split(' ', StringSplitOptions.RemoveEmptyEntries).Length)
            }).ToList();

        var wordLabels = wordGroups.Select(w => w.Date).ToArray();
        var wordValues = wordGroups.Select(w => w.Words).ToArray();

        await JS.InvokeVoidAsync("renderMoodChart", moodLabels, moodValues);
        await JS.InvokeVoidAsync("renderMoodCategoryChart", categoryLabels, categoryValues);
        await JS.InvokeVoidAsync("renderEntryChart", dayLabels, dayValues);
        await JS.InvokeVoidAsync("renderTagChart", tagLabels, tagValues);
        await JS.InvokeVoidAsync("renderTagBreakdownChart", tagBreakdownLabels, tagBreakdownValues);
        await JS.InvokeVoidAsync("renderWordChart", wordLabels, wordValues);
    }
}
