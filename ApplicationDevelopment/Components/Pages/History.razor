@page "/history"
@using ApplicationDevelopment.Model
@using ApplicationDevelopment.Service
@inject NavigationManager NavManager

<div class="history-page">

    <div class="history-header">
        <h2>Journal History</h2>
        <input type="text" class="search-box" placeholder="Search content or #tags..." 
               @bind="_searchText" @bind:event="oninput" />
    </div>

    <div class="history-list">
        @if (GetFilteredEntries().Count == 0)
        {
            <p class="text-center text-muted mt-5">No entries found.</p>
        }
        else
        {
            @foreach (var item in GetFilteredEntries())
            {
                <div class="history-card shadow-sm">
                    <div class="card-header">
                        <small>@item.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                        <div class="action-buttons">
                            <button class="btn btn-edit" @onclick="() => Edit(item.Id)">Edit</button>
                            <button class="btn btn-delete" @onclick="() => Delete(item.Id)">Delete</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="entry-content">@item.Content</p>
                        <p class="entry-mood"><strong>Mood:</strong> @item.PrimaryMood @(string.IsNullOrEmpty(item.SecondaryMood) ? "" : " / " + item.SecondaryMood)</p>
                        <div class="tag-container">
                            @foreach (var t in item.Tags)
                            {
                                <span class="tag-badge">#@t</span>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<style>
/* Page background */
.history-page {
    min-height: 100vh;
    background: #f5f4ff; /* light lavender */
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Header */
.history-header {
    width: 100%;
    max-width: 800px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.history-header h2 {
    color: #4a3f9d;
}

.search-box {
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #ccc;
    width: 50%;
}

/* Card */
.history-list {
    width: 100%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.history-card {
    background: #fff;
    border-radius: 1rem;
    overflow: hidden;
    border-left: 6px solid #5D3AEE;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Card header */
.history-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(120deg,#5D3AEE,#A56EFF);
    color: white;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

/* Action buttons */
.action-buttons button {
    margin-left: 0.5rem;
    padding: 0.3rem 0.6rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
}

.btn-edit {
    background: #ffdd57;
    color: #333;
}

.btn-edit:hover {
    opacity: 0.9;
}

.btn-delete {
    background: #ff6b6b;
    color: white;
}

.btn-delete:hover {
    opacity: 0.9;
}

/* Card body */
.card-body {
    padding: 1rem;
}

.entry-content {
    font-size: 1rem;
    line-height: 1.5;
    margin-bottom: 0.5rem;
}

.entry-mood {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.5rem;
}

/* Tags */
.tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}

.tag-badge {
    background: #dcd7f7;
    color: #5D3AEE;
    padding: 0.3rem 0.7rem;
    border-radius: 1rem;
    font-size: 0.85rem;
}
</style>

@code {
    private string _searchText = "";

    private List<JournalEntry> GetFilteredEntries()
    {
        if (string.IsNullOrWhiteSpace(_searchText))
            return JournalService.AllEntries;

        return JournalService.AllEntries.FindAll(x => 
            (!string.IsNullOrEmpty(x.Content) && x.Content.Contains(_searchText, StringComparison.OrdinalIgnoreCase)) ||
            x.Tags.Any(t => t.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
        );
    }

    private void Edit(Guid id)
    {
        NavManager.NavigateTo($"/edit-entry/{id}");
    }

    private void Delete(Guid id)
    {
        JournalService.DeleteEntry(id);
    }
}
