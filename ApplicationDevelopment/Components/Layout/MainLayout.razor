@inherits LayoutComponentBase
@using ApplicationDevelopment.Service
@inject IJSRuntime JS
@implements IDisposable

<div class="app-container">
    <!-- Vertical navigation sidebar -->
    <div class="vertical-navbar">
        <h4 class="nav-title">My Journal</h4>

        @if (_isLoggedIn)
        {
            <!-- Navigation links available only when user is logged in -->
            <NavLink href="/add-entry" class="nav-link" ActiveClass="active">Add Entry</NavLink>
            <NavLink href="/history" class="nav-link" ActiveClass="active">History</NavLink>
            <NavLink href="/calendar" class="nav-link" ActiveClass="active">Calendar</NavLink>
            <NavLink href="/dashboard" class="nav-link" ActiveClass="active">Dashboard</NavLink>
        }
        else
        {
            <!-- Locked navigation links for unauthenticated users -->
            <div class="nav-link locked-link">🔒 Add Entry</div>
            <div class="nav-link locked-link">🔒 History</div>
            <div class="nav-link locked-link">🔒 Calendar</div>
            <div class="nav-link locked-link">🔒 Dashboard</div>
        }

        <!-- Authentication navigation -->
        <NavLink href="/login" class="nav-link">Login</NavLink>
        <NavLink href="/register" class="nav-link">Register</NavLink>

        @if (_isLoggedIn)
        {
            <!-- Logout button visible only when user is logged in -->
            <button class="logout-btn" @onclick="Logout">Logout</button>
        }
    </div>

    <div class="main-content">

        <!-- Theme toggle section (light/dark mode) -->
        <div class="theme-topbar">
            <span class="theme-status">@_modeStatus</span>

            <div class="theme-toggle" @onclick="ToggleTheme">
                <span class="theme-icon">@_themeIcon</span>
                <span class="theme-text">@_themeText</span>

                <div class="switch">
                    <div class="switch-circle @( _isDarkMode ? "on" : "" )"></div>
                </div>
            </div>
        </div>

        <!-- Render page content here -->
        @Body
    </div>
</div>

<style>
/* Application layout container */
.app-container { display:flex; min-height:100vh; }

/* Sidebar navigation styling */
.vertical-navbar {
    width:220px;
    background: var(--nav-bg);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-top:2rem;
    box-shadow:3px 0 8px rgba(0,0,0,0.1);
    position:fixed;
    top:0; left:0; bottom:0;
}

/* Sidebar title styling */
.nav-title {
    color:#fff;
    font-size:1.5rem;
    font-weight:700;
    margin-bottom:2rem;
}

/* Navigation link styling */
.nav-link {
    color:#fff;
    font-weight:600;
    font-size:1.1rem;
    padding:.8rem 1.5rem;
    margin-bottom:1rem;
    border-radius:.5rem;
    text-decoration:none;
    width:90%;
    text-align:center;
    transition:.3s;
}

/* Hover effect for navigation links */
.nav-link:hover {
    background:rgba(255,255,255,.2);
    transform:scale(1.05);
}

/* Active navigation link styling */
.nav-link.active {
    background:rgba(255,255,255,.4);
    color:#023E8A;
}

/* Locked navigation link styling */
.locked-link {
    opacity:0.4;
    cursor:not-allowed;
    pointer-events:none;
}

/* Logout button styling */
.logout-btn {
    margin-top:1rem;
    background:#fff;
    border:none;
    padding:.5rem 1rem;
    border-radius:.5rem;
    cursor:pointer;
}

/* Main content area styling */
.main-content {
    margin-left:220px;
    padding:2rem;
    width:calc(100% - 220px);
    background-color: var(--bg-color);
    min-height:100vh;
    color: var(--text-color);
}

/* Theme toggle UI styling */
.theme-topbar {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:12px;
    margin-bottom:1rem;
}

.theme-status {
    font-weight:600;
    font-size:0.95rem;
}

.theme-toggle {
    display:flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    background: var(--card-color);
    padding:6px 12px;
    border-radius:20px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    transition:0.3s;
}

.theme-toggle:hover {
    transform:scale(1.05);
}

.theme-icon {
    font-size:1rem;
}

.theme-text {
    font-weight:600;
    font-size:0.9rem;
}

.switch {
    width:42px;
    height:22px;
    background:#ccc;
    border-radius:20px;
    position:relative;
    transition:0.3s;
}

.switch-circle {
    width:18px;
    height:18px;
    background:white;
    border-radius:50%;
    position:absolute;
    top:2px;
    left:2px;
    transition:0.3s;
}

.switch-circle.on {
    transform:translateX(20px);
}

/* Dark mode styling for toggle switch */
body.dark-theme .switch {
    background:#00B4D8;
}
</style>

@code {
    // Tracks whether the user is logged in
    private bool _isLoggedIn;

    // Theme-related state variables
    private bool _isDarkMode = false;
    private string _themeText = "Light Mode";
    private string _themeIcon = "☀️";
    private string _modeStatus = "Dark Mode OFF";

    // Initialize authentication state and subscribe to auth state changes
    protected override void OnInitialized()
    {
        _isLoggedIn = AuthService.IsLoggedIn();
        AuthService.OnAuthStateChanged += Refresh;
    }

    // Check and load theme state after the component is rendered
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDarkMode = await JS.InvokeAsync<bool>("themeManager.isDarkMode");
            UpdateThemeUI();
            StateHasChanged();
        }
    }

    // Refresh UI when authentication state changes
    private void Refresh()
    {
        _isLoggedIn = AuthService.IsLoggedIn();
        InvokeAsync(StateHasChanged);
    }

    // Toggle between light and dark theme using JavaScript interop
    private async Task ToggleTheme()
    {
        _isDarkMode = await JS.InvokeAsync<bool>("themeManager.toggleTheme");
        UpdateThemeUI();
    }

    // Update UI text and icons based on current theme
    private void UpdateThemeUI()
    {
        if (_isDarkMode)
        {
            _themeText = "Dark Mode";
            _themeIcon = "🌙";
            _modeStatus = "Dark Mode ON";
        }
        else
        {
            _themeText = "Light Mode";
            _themeIcon = "☀️";
            _modeStatus = "Dark Mode OFF";
        }
    }

    // Log out the user and update authentication state
    private void Logout()
    {
        AuthService.Logout();
    }

    // Unsubscribe from authentication event to avoid memory leaks
    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= Refresh;
    }
}
